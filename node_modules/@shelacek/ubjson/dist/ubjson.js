Object.defineProperty(exports,"t",{value:!0});class t{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.r=t,this.e=new("undefined"!=typeof TextEncoder?TextEncoder:require("util").TextEncoder)}encode(t){const r=this.s(t),e=r.reduce((t,r)=>t+r.byteLength,0),s=new Uint8Array(e),n={array:s,view:new DataView(s.buffer)};let i=0;for(const t of r)t.storer(n,i),i+=t.byteLength;return s.buffer}s(t){const r=this.n(t);return[this.i(r),...this.h(t,r)]}h(t,r){let e,s;switch(r){case"C":return e=t.charCodeAt(),[this.a((t,r)=>t.view.setInt8(r,e),1)];case"S":return s=this.e.encode(t),[...this.s(s.byteLength),this.c(s)];case"i":return[this.a((r,e)=>r.view.setInt8(e,t),1)];case"U":return[this.a((r,e)=>r.view.setUint8(e,t),1)];case"I":return[this.a((r,e)=>r.view.setInt16(e,t),2)];case"l":return[this.a((r,e)=>r.view.setInt32(e,t),4)];case"d":return[this.a((r,e)=>r.view.setFloat32(e,t),4)];case"D":return[this.a((r,e)=>r.view.setFloat64(e,t),8)];case"[":return this.u(t);case"{":return this.o(t)}return[]}n(t){if(null===t)return"Z";switch(typeof t){case"undefined":return"N";case"boolean":return t?"T":"F";case"string":return 1===t.length&&t.charCodeAt()<=127?"C":"S";case"number":if(Number.isInteger(t)){if(-128<=t&&t<=127)return"i";if(0<=t&&t<=255)return"U";if(-32768<=t&&t<=32767)return"I";if(-2147483648<=t&&t<=2147483647)return"l"}return Number.isNaN(t)||Math.fround(t)===t?"d":"D";case"object":return Array.isArray(t)||ArrayBuffer.isView(t)?"[":"{"}throw Error("Value cannot be serialized")}u(t){let r;if((!0===this.r.optimizeArrays||"onlyTypedArrays"===this.r.optimizeArrays)&&ArrayBuffer.isView(t))switch(t.constructor.name){case"Int8Array":return[].concat(this.l("i",t.length),this.c(t));case"Uint8Array":return[].concat(this.l("U",t.length),this.c(t));case"Int16Array":r="I";break;case"Int32Array":r="l";break;case"Float32Array":r="d";break;case"Float64Array":r="D"}const e=(Array.isArray(t)?t:Array.from(t)).map(t=>({type:r||this.n(t),value:t}));return this.d(e,"]",r||!0===this.r.optimizeArrays)}o(t){const r=Object.entries(t).map(t=>({key:t[0],type:this.n(t[1]),value:t[1]}));return this.d(r,"}",!0===this.r.optimizeObjects)}l(t,r){const e=[];return null!=r&&(t&&e.push(this.i("$"),this.i(t)),e.push(this.i("#"),...this.s(r))),e}d(t,r,e){let s,n;e&&(t.length&&(s=this.y(t)),n=t.length);const i=this.l(s,n);for(const r of t)r.key&&i.push(...this.h(r.key,"S")),!s&&i.push(this.i(r.type)),i.push(...this.h(r.value,s||r.type));return null==n&&i.push(this.i(r)),i}y(t){const r=t.map(t=>t.type).reduce(this.f);return"U"===r&&t.some(t=>t.value<0)?"I":r}f(t,r){if(t===r)return t;if(!t)return null;const e=e=>e[Math.min(e.indexOf(t),e.indexOf(r))];return e("Dd")||e("SC")||e("lIUi")}i(t){return this.a((r,e)=>r.view.setInt8(e,t.charCodeAt()),1)}c(t){return this.a((r,e)=>r.array.set(t,e),t.byteLength)}a(t,r){return{storer:t,byteLength:r}}}class r{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.r=t,this.p=new("undefined"!=typeof TextDecoder?TextDecoder:require("util").TextDecoder)}decode(t){const r=new Uint8Array(t),e=new DataView(r.buffer);return this.w={array:r,view:e},this.A=0,this._()}_(){switch(arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.b(!1)){case"Z":return null;case"N":return;case"T":return!0;case"F":return!1;case"i":return this.I((t,r)=>t.view.getInt8(r),1);case"U":return this.I((t,r)=>t.view.getUint8(r),1);case"I":return this.I((t,r)=>t.view.getInt16(r),2);case"l":return this.I((t,r)=>t.view.getInt32(r),4);case"L":return this.U(8,this.r.int64Handling,!0);case"d":return this.I((t,r)=>t.view.getFloat32(r),4);case"D":return this.I((t,r)=>t.view.getFloat64(r),8);case"H":return this.U(this.k(),this.r.highPrecisionNumberHandling,!1);case"C":return String.fromCharCode(this._("i"));case"S":return this.x(this.k());case"[":return this.T();case"{":return this.g()}throw Error("Unexpected type")}v(){let t,r;switch(this.b(!0)){case"$":if(this.D(),t=this.b(!1),"#"!==this.b(!0))throw Error("Expected count marker");case"#":this.D(),r=this.k()}return{type:t,count:r}}T(){const t=this.v(),r=t.type,e=t.count;if(-1!=="ZTF".indexOf(r))return Array(e).fill(this._(r));if(this.r.useTypedArrays)switch(r){case"i":return this.S(e);case"U":return this.C(e);case"I":return Int16Array.from({length:e},()=>this._(r));case"l":return Int32Array.from({length:e},()=>this._(r));case"d":return Float32Array.from({length:e},()=>this._(r));case"D":return Float64Array.from({length:e},()=>this._(r))}if(null!=e){const t=Array(e);for(let s=0;s<e;s++)t[s]=this._(r);return t}{const t=[];for(;"]"!==this.b(!0);)t.push(this._());return this.D(),t}}g(){const t=this.v(),r=t.type,e=t.count,s={};if(null!=e)for(let t=0;t<e;t++)s[this._("S")]=this._(r);else{for(;"}"!==this.b(!0);)s[this._("S")]=this._();this.D()}return s}k(){const t=this._();if(Number.isInteger(t)&&t>=0)return t;throw Error("Invalid length/count")}U(t,r,e){switch(r){case"skip":return void this.D(t);case"raw":return e?this.C(t):this.x(t)}throw Error("Unsuported type")}C(t){return this.I((r,e)=>{let s=r.array;return new Uint8Array(s.buffer,e,t)},t)}S(t){return this.I((r,e)=>{let s=r.array;return new Int8Array(s.buffer,e,t)},t)}x(t){return this.I((r,e)=>{let s=r.array;return this.p.decode(new DataView(s.buffer,e,t))},t)}D(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.m(t),this.A+=t}b(t){const r=this.w,e=r.array,s=r.view;let n="N";for(;"N"===n&&this.A<e.byteLength;)n=String.fromCharCode(s.getInt8(this.A++));return t&&this.A--,n}I(t,r){this.m(r);const e=t(this.w,this.A);return this.A+=r,e}m(t){if(this.A+t>this.w.array.byteLength)throw Error("Unexpected EOF")}}function e(r,e){return new t(e).encode(r)}function s(t,e){return new r(e).decode(t)}const n={encode:e,decode:s};exports.UbjsonEncoder=t,exports.UbjsonDecoder=r,exports.encode=e,exports.decode=s,exports.Ubjson=n;
//# sourceMappingURL=ubjson.js.map
